#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

param select /data/px4/param/parameters

# Start the NHB Airframe by default
# This is not currently used by VOXL2 yet unfortunately.
# thus the duplication between this and the 22200_nhb_revB
param set SYS_AUTOSTART 22200

# ********* NHB Defaults ********* #
set VEHICLE_TYPE mc

# MAV_TYPE_QUADROTOR 2
param set MAV_TYPE 2

if param compare IMU_GYRO_RATEMAX 400
then
	param set IMU_GYRO_RATEMAX 800
fi

param set NAV_ACC_RAD 2

param set RTL_RETURN_ALT 30
param set RTL_DESCEND_ALT 10

param set GPS_UBX_DYNMODEL 6

######### UMS_ALL_VEHICLES.PARM ########
#!/bin/sh
#
# Parameters for All Vehicles
#
#
#


# This parameter is a kludge in the code that defines behaviors specific to modal's vehicles
# Be careful items and features defined under it could easily be moved outside of its scope
param set MODALAI_CONFIG 1

### ITEMS UNDER TEST ###
param set EKF2_BOUNCE_FIX 1

### ITEMS UNDER TEST ###

# Battery Parameters
# Note we do not actually use the capacity estimates for failsafes or user notifications
# Thus they may be populated here but could be incorrect
param set BAT1_CAPACITY 2800.0000
param set BAT1_N_CELLS 6
param set BAT1_R_INTERNAL 0.0123
param set BAT1_V_EMPTY 2.75
param set BAT_N_CELLS 6
param set BAT_LOW_VOLT 18.6
param set BAT_LOW_V_TIME 10
param set BAT_LOW_THR 0.0
param set BAT_CRIT_THR 0.0
param set BAT_EMERGEN_THR 0.0


# Control Allocator
param set CA_R_REV 0
param set CA_AIRFRAME 0
param set CA_ROTOR_COUNT 4


# arming / disarming params
param set COM_ARM_EKF_BIAS 0.0000
param set COM_ARM_EKF_HGT 0.0000
param set COM_ARM_EKF_VEL 0.000
param set COM_ARM_EKF_POS 0.000
param set COM_ARM_EKF_YAW 0.000

# COM_BAT_ACT_T 10.0 (old default) vs 5.0 new default
# https://github.com/PX4/PX4-Autopilot/commit/455b885f86754985fb07726b7975f0f028537204#diff-98b4e0f87126f3486c8dda8f693ee45c682a856f17958aed5a33d51e5fd27766L300
# Renamed COM_BAT_ACT_T  -> COM_FAIL_ACT_T
# I do not like this as it could?? affect other failsafe types other than battery?
# change in behavior?
#
# For now leave at new default
# param set COM_FAIL_ACT_T 10.0

# note these Probably doesnt matter
# COM_POS_FS_EPV 10

param set COM_ARM_BAD_INOV 1
param set COM_ARM_IMU_ACC 0.0
param set COM_ARM_IMU_GYR 0.0
param set COM_ARM_MAG_ANG -1

# RC controller mapping params
# Map all to Altitude Control
param set COM_FLTMODE1 1
param set COM_FLTMODE2 1
param set COM_FLTMODE3 1
param set COM_FLTMODE4 1
param set COM_FLTMODE5 1
param set COM_FLTMODE6 1

# Bootup Flight Mode is Altitude Hold
param set COM_FLTMODE_INIT 1

param set COM_DISARM_FORCE 1
param set COM_DISARM_PRFLT -1.0000
param set FD_FAIL_P 180
param set FD_FAIL_R 180


# Estimation EKF params

# Optical flow params
# Turn off Optical Flow Explictly
param set EKF2_OF_CTRL 0

# EKF2_OF_DELAY 20.0 ms (default) or 80.0 ms on Modal Params
# EKF2_OF_N_MIN 0.15 rad/s vs default of 0.5 rad/s

# Turn off Fake Position Fusion
param set EKF2_FP_ALIM 0.0

# EKF_AID mask (normal == 0)  (2 == enable optical fusion)
param set EKF2_AID_MASK 0

# GPS do not fuse any gps readings into the EKF
param set EKF2_GPS_CTRL 0

# EKF2_IMU_CTRL disable accel and gyro bias estimation and enable gravity fusion
param set EKF2_IMU_CTRL 4
param set EKF2_GRAV_NOISE 1.0

# Baro noise is approximately 0.75m when out of ground effect from logs
param set EKF2_BARO_NOISE 0.75
param set EKF2_GND_EFF_DZ 0.0

param set EKF2_MAG_TYPE 5

# Single-instance EKF Params
# These changed ??? ot N/A
# While we should have plenty of power for many ekf lanes
# it does open up more code
param set SENS_MAG_MODE 1
param set SENS_IMU_MODE 1
param set EKF2_MULTI_MAG 0
param set EKF2_MULTI_IMU 0

param set EKF2_GPS_CHECK 0
param set EKF2_MAG_CHECK 0

# EKF Range Finder Params
param set EKF2_RNG_CTRL 0
# EKF2_RNG_A_HMAX 5.0 (default) or modal 1.0
# EKF2_RNG_NOISE 0.1 (default) or 1.0


# GPS EKF Checks
param set EKF2_REQ_EPH 6.0000
param set EKF2_REQ_EPV 10.0000
param set EKF2_REQ_PDOP 3.5000
param set EKF2_REQ_SACC 1.0000

# Geofence Failsafe Action
param set GF_ACTION 1

# GPS
# uneeded  I think??
# param set GPS_1_CONFIG 201
# GPS_UBX_DYNMODEL 6 or Modal 7 (default)
# We may want to change to
# param set GPS_UBX_DYNMODEL 6

# Hover Thrust Estimator Params
# We have problems with this section of code and need to work on all the HTE params
param set HTE_HT_NOISE 0.0005

# MPC_THR_HOVER should be between hover thrust estimator's min/max
# We need to test this minimum further... especially during ground effect to find the true minimum hover level.
# Note previously HTE_THR_MIN was effectively 0.0
param set HTE_THR_MIN 0.05
param set HTE_THR_MAX 0.6

# IMU noise filtering params
param set IMU_GYRO_RATEMAX 800
param set IMU_DGYRO_CUTOFF 60.0000
param set IMU_GYRO_CUTOFF 180.0000
param set IMU_GYRO_DNF_BW 20.0000
param set IMU_GYRO_DNF_EN 2

# IMU FFT Filtering
param set IMU_GYRO_FFT_EN 1
param set IMU_GYRO_FFT_LEN 1024
param set IMU_GYRO_FFT_MAX 192.0000
param set IMU_GYRO_FFT_MIN 32.0000

# Shows as N/A on vehicle but can be in the code on 1.14?
# This module might not be starting?
# param set IMU_GYRO_CAL_EN 1

# Commander only allow manual input from an RC transmitter
param set COM_RC_IN_MODE 0

#######################################
# Commander RC Failsafe Parameters
#    Our failsafe behavior is upon loss of RC inputs after `COM_RC_LOSS_T` seconds then we switch to
#	a blind land mode (as set by `NAV_RLC_ACT``). Next after an additional `COM_RCL_ACT_T` seconds
#	the mode switches to `COM_RLC_ACT` (disarm).
#
#    Our landing speeds are set such that we descend at 1m/s. This setup allows us to descend approximately one floor
#	before the disarm action occurs.
#
#
# Failsafe Action 1
# 	DESCEND the vehicle after the time given by COM_RC_LOSS_T in seconds
param set NAV_RCL_ACT 7
param set COM_RC_LOSS_T 0.3
#
# Land Mode Descent Speed (m/s)
param set MPC_LAND_SPEED 3.0
#
# Failsafe Action 2 (Override)
#	Next disarm the vehicle COM_RCL_ACT_T seconds after COM_RC_LOSS_T occurs
param set COM_RCL_ACT 6
param set COM_RCL_ACT_T 4.3
#
# Landing Detector Parameter
#
# Note the land detector may disarm the vehicle before COM_RCL_ACT occurs
#  * LNDMC_ALT_GND Turns off ground effect compensation
#  * The height above ground below which ground effect creates barometric altitude errors.
#  * A negative value indicates no ground effect.
#  * The landing detector is dependent on the Z-axis velocity. The z-axis velocity must be below LNDMC_Z_VEL_MAX.
#  * MPC_LAND_CRWL must be set 1.2 times bigger than LNDMC_Z_VEL_MAX. If not, LNDMC_Z_VEL_MAX get lowered automatically.
param set LNDMC_Z_VEL_MAX 0.50
param set MPC_LAND_CRWL 1.0
param set LNDMC_ALT_GND -1.0000
# Time-out for auto disarm after landing
param set COM_DISARM_LAND 0.5
#######################################

# Commander Offboard Control Params
param set COM_OF_LOSS_T 3.0

# Module: magnetometer_bias is not starting
# These are N/A on vehicle
# MBE_ENABLE & MBE_LEARN_GAIN

# Set the vehicle type to Quadrotor
param set MAV_TYPE 2

# Turn off Arm/Disarm using stick gestures
param set MAN_ARM_GESTURE 0

# FIXME COME BACK TO MC MPC
# in course params
# MC_AT_EN 1  auto tune is enabled !!!!
# also that param is not found in 1.14
# module not started

# RC controller feel params
param set MC_ACRO_EXPO 0.30
param set MC_ACRO_EXPO_Y 0.30
param set MC_ACRO_P_MAX 600.0
param set MC_ACRO_R_MAX 600.0
param set MC_ACRO_SUPEXPO 0.84
param set MC_ACRO_SUPEXPOY 0.84
param set MC_ACRO_Y_MAX 600.0


# Multi-Copter Position Control
# Flight Performance restriction params
param set MPC_MANTHR_MIN 0.0400
param set MPC_MAN_TILT_MAX 20.0000
param set MPC_TILTMAX_AIR 20.0000

# Turn off TAU filtering on yaw. This is on by default to 0.008s for PX4
param set MPC_MAN_Y_MAX 450.0
param set MPC_MAN_Y_TAU 0.0

param set MPC_THR_MAX 0.8000
param set MPC_THR_MIN 0.0400
param set MPC_THR_HOVER 0.23

param set MPC_JERK_MAX 15.0000

param set MPC_Z_MAN_EXPO 0.30

# Z (Altitude) Settings
# MPC_POS_MODE -> Hold position with Velocity Input
param set MPC_POS_MODE 1

# MPC_VZ_SRC use the z_derivative for Z Position control
param set MPC_VZ_SRC 1

param set MPC_Z_VEL_MAX_DN 6.0
param set MPC_Z_VEL_MAX_UP 6.0

param set MPC_Z_V_AUTO_UP 1.3000
param set MPC_Z_V_AUTO_DN 1.0

# OSD Params
param set OSD_SCROLL_RATE 100
param set OSD_LOG_LEVEL 4
param set OSD_DWELL_TIME 750


echo -e "\n*************************"
echo "GPS: $GPS"
echo "RC: $RC"
echo "ESC: $ESC"
echo "POWER MANAGER: $POWER_MANAGER"
echo "DISTANCE SENSOR: $DISTANCE_SENSOR"
echo "OSD: $OSD"
echo "ARTIFACT_MODE: $ARTIFACT_MODE"
echo "EXTRA STEPS:"
for i in "${EXTRA_STEPS[@]}"
do
	echo -e "\t$i"
done
echo -e "*************************\n"

# Optional MSP OSD driver for DJI or HDZero goggles
# This is only supported on M0054 (with M0125 accessory board)
# if [ "$OSD" == "ENABLE" ] || [ "$OSD" == "DJI" ] || [ "$OSD" == "MSP_DJI" ] then
	# On Screen Display (OSD) Params
	param set OSD_CH_HEIGHT -2
	param set OSD_SYMBOLS 786945
	param set OSD_BATT_LOW_V 18.6
	param set OSD_HDG_RST_CHAN 2
	param set OSD_DISPLAY_OPTS 1
#elif [ "$OSD" == "HDZERO" ] || [ "$OSD" == "MSP_DP" ] then
	# HD: ROW [0-19], COL[0-49]
	param set OSD_CBATT_COL 36
	param set OSD_CBATT_ROW 19
	param set OSD_CH_COL 25
	param set OSD_CH_ROW 11
	param set OSD_CURR_COL 47
	param set OSD_CURR_ROW 19
	param set OSD_FM_COL 12
	param set OSD_FM_ROW 19
	# param set OSD_HDG_COL 25
	# param set OSD_HDG_ROW 0
	param set OSD_STATUS_COL 21
	param set OSD_STATUS_ROW 19

# RSSI Doesnt works  shows 30 1 foot away
# STATUS also shows a weird message when you change OSD params
#	param set OSD_RSSI_COL -1
#	param set OSD_RSSI_ROW -1
# 	param set OSD_BATT_COL -1
#	param set OSD_BATT_ROW -1
	# param set OSD_DIS_COL -1
	# param set OSD_DIS_ROW -1

#fi



# Parameter Selector Module
param set SELECTOR_ENABLED 1
param set PSET_MODE 3
param set PSET_CHANNEL 6
param set PSET_FST_VELZ 5.0
param set PSET_MED_VELZ 2.0

# RC Ranges
# These are the full normal range of a TangoIIs, Radiomaster TX16s, etc.
# This assumes the RC transmitter has had its settings changed such that
# the output range matches as close as possible IE 1000 uSec approx. equal to 997 uSec
# MIN 1000.0 , TRIM 1500, MAX 2000

param set RC1_MIN 1000.0
param set RC1_MAX 2000.0
param set RC1_TRIM 1500.0

param set RC2_MIN 1000.0
param set RC2_MAX 2000.0
param set RC2_TRIM 1500.0

param set RC3_MIN 1000.0
param set RC3_MAX 2000.0
param set RC3_TRIM 1000.0

param set RC4_MIN 1000.0
param set RC4_MAX 2000.0
param set RC4_TRIM 1500.0

param set RC5_MIN 1000.0
param set RC5_MAX 2000.0
param set RC5_TRIM 1500.0

param set RC6_MIN 1000.0
param set RC6_MAX 2000.0
param set RC6_TRIM 1500.0

param set RC7_MIN 1000.0
param set RC7_MAX 2000.0
param set RC7_TRIM 1500.0

param set RC8_MIN 1000.0
param set RC8_MAX 2000.0
param set RC8_TRIM 1500.0

param set RC9_MIN 1000.0
param set RC9_MAX 2000.0
param set RC9_TRIM 1500.0

param set RC10_MIN 1000.0
param set RC10_MAX 2000.0
param set RC10_TRIM 1500.0

param set RC11_MIN 1000.0
param set RC11_MAX 2000.0
param set RC11_TRIM 1500.0

param set RC12_MIN 1000.0
param set RC12_MAX 2000.0
param set RC12_TRIM 1500.0

# RC Mapping
# Aux1 : Turtle Mode
# Aux2 : OSD Heading Reset
param set RC_MAP_ARM_SW 5
param set RC_MAP_AUX1 10
param set RC_MAP_AUX2 8
param set RC_MAP_FLTMODE 6
#param set RC_MAP_KILL_SW 9

param set RC_MAP_PITCH 2
param set RC_MAP_ROLL 1
param set RC_MAP_THROTTLE 3
param set RC_MAP_YAW 4

# Logging
# Enable Defaults & EKF_Replay
# FIXME Initial Flight_Test Log profile causes odd twitches in hover or increasing/decreasing throttle
param set SDLOG_PROFILE 0

# SKIP THE SENS_xxx params for now
# most are correctly N?A since why load info for sensors we dont have

# Optical Flow Sensors
# param set SENS_FLOW_MINHGT 0.70
# param set SENS_FLOW_MAXR 2.5
# param set SENS_FLOW_ROT 2

# Magnetometer
param set SENS_MAG_AUTOCAL 0

# Multi-GPS blending control set to always use the first instance
param set SENS_GPS_MASK 0

# Temperature Calibration Parameters do not exist
# we may want these later
# module may not be starting
# SYS_CAL_ACCEL
# SYS_CAL_GYRO
# etc

# Sensor Drivers
# Enable GPS
# Disable magnetometer for now
param set SYS_HAS_GPS 1
param set SYS_HAS_MAG 0

# Temperature Compensation for Accel, Baro, Gyro
# is not loading
# TC_A_ENABLE
# TC_B_ENABLE
# TC_G_ENABLE

# Disable UAVCAN
 param set UAVCAN_ENABLE 0

######## END UMS_ALL_VEHICLES.PARM ########


######## ums_escs_modalai_tmotor_45A.parm ########

#!/bin/sh
#
# ModalAI T-Motor 45A (reflashed firmware see voxl-esc-tools)
#
# Manufacturer : ModalAI
# Max. Current : 45A
# Max. Volts : 6S
# Website :


# VoXL_ESC
param set VOXL_ESC_CONFIG 1
param set VOXL_ESC_BAUD 2000000
param set VOXL_ESC_MODE 1
param set VOXL_ESC_VLOG 1

# Vehicle Customized Parameters
# Motor Ordering is dependent on the

# # Motor Ordering
# # FUNC1 -> MOTOR1
# # FUNC2 -> MOTOR4
# # FUNC3 -> MOTOR2
# # FUNC4 -> MOTOR3
# #
# param set VOXL_ESC_FUNC1 102
# param set VOXL_ESC_FUNC2 104
# param set VOXL_ESC_FUNC3 101
# param set VOXL_ESC_FUNC4 103

# param set VOXL_ESC_SDIR1 0
# param set VOXL_ESC_SDIR2 0
# param set VOXL_ESC_SDIR3 0
# param set VOXL_ESC_SDIR4 0

######## ums_escs_modalai_tmotor_45A.parm ########


######## ums_motors_xing_2207_1855kv ########

#!/bin/sh
#
# Xing 2207 1855 kV
#
# Manufacturer : Xing
# kV : 1855
# Max. volts : 6S
# Website :

param set THR_MDL_FAC 0.8069

# If a ModalAI ESC is used then set the RPM based control limits
if param greater -s VOXL_ESC_CONFIG 0
then
	param set VOXL_ESC_RPM_MAX 24000
	param set VOXL_ESC_RPM_MIN 3000
fi

######## END ums_motors_xing_2207_1855kv ########


######## ums_rc_control_crsf.parm ########

#!/bin/sh
#
# Radio Control TBS CRSF
#
# Manufacturer : TBS
# Examples: TBS Crossfire Nano. Crossfire Nano diversity, Tracer nano
# Website :

param set RC_INPUT_PROTO 6

# CRSF has 12 channels
param set RC_CHAN_CNT 12

######## END ums_rc_control_crsf.parm ########



######## ums_flight_controllers_voxl2.parm ########

#!/bin/sh
#
# Flight Controlers Voxl2
# Voxl2 only parameters
#
# This allows different platforms Voxl2, STM, NXP to inherit separatley

# Disable Power Supply Checking
# FIXME : This doesn't work yet on Voxl2
# Note this check will prevent arming but will not print a message to QGC!
param set CBRK_SUPPLY_CHK 894281

# Allow arming without an SD Card and do not warn
# FIXME Check this actually functions for voxl2 if you actually have an sdcard attached
param set COM_ARM_SDCARD 0

# FIXME this doesn't function yet as Modal needs to map the SLPI cpu usage to mUorb and then to PX4
param set COM_CPU_MAX -1.0

# Logging
# To change the logging profile on a drone go into `/usr/bin/voxl-px4-start``
# "logger start"
# To change the log profile in the repo and all new firmware builds
#  Change the line in `boards/modalai/voxl2/target/voxl-px4-start``

# FIXME SDLOG_MODE is not able to be used yet on VOXL2
# Log from first armed until shutdown
param set SDLOG_MODE -1


#### THESE checks may not function on voxl2 ####

# System Checks and Config
# param set SYS_DM_BACKEND 1

# Enables Stack checking
# param set SYS_STCK_EN 1


######### ums_airframes_revB.parm ########

# Control Allocator

# PX4 Motor #1
param set CA_ROTOR0_PX 0.14678
param set CA_ROTOR0_PY 0.19140
param set CA_ROTOR0_KM 0.050

# PX4 Motor #2
param set CA_ROTOR1_PX -0.14678
param set CA_ROTOR1_PY -0.17110
param set CA_ROTOR1_KM 0.050

# PX4 Motor #3
param set CA_ROTOR2_PX 0.14678
param set CA_ROTOR2_PY -0.19140
param set CA_ROTOR2_KM -0.05

# PX4 Motor #4
param set CA_ROTOR3_PX -0.14678
param set CA_ROTOR3_PY 0.17110
param set CA_ROTOR3_KM -0.05


# PID controller tuning params

param set MC_PITCH_P 13.5
param set MC_PITCH_CUTOFF 20.160646
param set MC_PITCHRATE_D 0.0015638
param set MC_PITCHRATE_I 0.0551
param set MC_PITCHRATE_MAX 1600
param set MC_PITCHRATE_P 0.1102094
param set MC_ACRO_PRATE_I 1.543

param set MC_ROLL_P 13.5
param set MC_ROLL_CUTOFF 17.518
param set MC_ROLLRATE_D 0.0014290
param set MC_ROLLRATE_I 0.05035
param set MC_ROLLRATE_MAX 1600
param set MC_ROLLRATE_P 0.10070770
param set MC_ACRO_RRATE_I 1.410

param set MC_YAW_P 1.5
param set MC_YAW_CUTOFF 20.010
param set MC_YAWRATE_I 6.3022708
param set MC_YAWRATE_MAX 1300.0000
param set MC_YAWRATE_P 0.1658710

# Attitude Control Rate Feedforward settings
param set MC_FF_FACTOR 1.0
param set MC_MAX_FF_SPEED 1000.0
param set MC_FF_TILT_TAU 0.04

# XY Settings
param set MPC_XY_P 0.80
param set MPC_XY_VEL_D_ACC 0.0
param set MPC_XY_VEL_I_ACC 0.4000
param set MPC_XY_VEL_P_ACC 1.2000

# Z (Altitude) Settings
param set MPC_Z_P 0.3
param set MPC_Z_VEL_D_ACC 0.0
param set MPC_Z_VEL_I_ACC 4.8
param set MPC_Z_VEL_P_ACC 5.7000

######### END ums_airframes_revB.parm ########


######## ums_estimation_and_control_altitude_hold_only.parm ########

#!/bin/sh
#
# Estimation and Control
#
# Description :  Enables only estimation and control params needed for altitude hold. All other sources are turned off
#
# Estimation Types :
#	Baro : YES
#	GPS : not fused
#	Magnetometer : not fused or enabled (in all vehicles)
#	External Vision : none
#	Rangefinder : none onboard, not fused or enabled (in all vehicles)
# Control Modes:
#	Altitude Hold, Velocity controlled : YES (in all vehicles)
#	Position Control : none


# Turn off using external vision inputs to the EKF
param set EKF2_EV_CTRL 0

# Sets the height reference to be baro
param set EKF2_HGT_REF	0

# Flight Mode
# Set Mode 6 to altitude control
param set COM_FLTMODE6 1

######## END ums_estimation_and_control_altitude_hold_only.parm ########

#####################################
# Flight Controller
# ModalAI : VOXL2
# Qualcomm

# CRSF RC_Input
# PX4 Port Name :
# Connector :

# GPS
# PX4 Port Name :
# Connector :

# For RC CRSF Input
# MAV1_CONFIG Telem2

# MSP OSD
# MSP_OSD_CONFIG 101 ?? N/A on vehicle
# param set MSP_OSD_CONFIG 101

# Serial and sensor configuration is done in the startup script
# located in /usr/bin/voxl-px4-start


# Flight Controller Rotation : Yaw 180 deg
param set SENS_BOARD_ROT 4

# IMU position with respect to the CG
# FIXME these values are the same for Rev0
param set EKF2_IMU_POS_Y -0.0155
param set EKF2_IMU_POS_Z 0.0040

# FIXME this DGYRO is quite low
param set IMU_DGYRO_CUTOFF 20.0000


# ESC Motor Mapping & Directions

# Motor Ordering
# FUNC1 -> MOTOR3
# FUNC2 -> MOTOR2
# FUNC3 -> MOTOR4
# FUNC4 -> MOTOR1
#
param set VOXL_ESC_FUNC1 103
param set VOXL_ESC_FUNC2 102
param set VOXL_ESC_FUNC3 104
param set VOXL_ESC_FUNC4 101

param set VOXL_ESC_SDIR1 1
param set VOXL_ESC_SDIR2 1
param set VOXL_ESC_SDIR3 1
param set VOXL_ESC_SDIR4 1


# ********* END NHB Defaults ********* #

param save

sleep 2

# Need px4-shutdown otherwise Linux system shutdown is called
px4-shutdown
